extends Node2D

var bpm = 138
var beatsPerBar = 4
var secsPerBeat = (60.0 / bpm)
var message = ""
var perfectTimingWindow = secsPerBeat / 15
var goodTimingWindow = secsPerBeat / 8

var rand = 0;
var note = preload("res://Scenes/Note.tscn")
var notes = [0.0,0.21739150000000002,0.43478300000000003,0.54347875,0.76087025,0.8695660000000001,1.0869575,1.304349,1.7391320000000001,1.9565235,2.173915,2.28261075,2.50000225,2.608698,2.8260895,3.043481,3.4782640000000002,3.6956555,3.913047,4.0217427500000005,4.23913425,4.34783,4.5652215,4.7826130000000004,5.217396,5.4347875000000005,5.652179,5.76087475,5.97826625,6.086962,6.3043535,6.9565280000000005,7.1739195,7.391311,7.50000675,7.7173982500000005,7.826094,8.043485500000001,8.260877,8.69566,8.9130515,9.130443,9.23913875,9.45653025,9.565226000000001,9.7826175,10.434792,10.6521835,10.869575000000001,10.97827075,11.19566225,11.304358,11.5217495,11.739141,12.173924,12.391315500000001,12.608707,12.71740275,12.93479425,13.04349,13.2608815,13.478273,13.913056000000001,14.1304475,14.347839,14.456534750000001,14.673926250000001,14.782622,15.0000135,15.217405000000001,15.652188,15.8695795,16.086971000000002,16.19566675,16.41305825,16.521754,16.7391455,17.1739285,17.608711500000002,17.826103,18.260886,18.4782775,18.9130605,19.130452000000002,20.000018,20.2174095,20.434801,20.6521925,21.0869755,21.304367,21.739150000000002,21.9565415,22.173933,23.478282,23.6956735,23.913065,24.1304565,25.4348055,25.652197,26.304371500000002,26.521763,27.1739375,27.353738386458335,27.391329,28.913069500000002,29.130461,30.434810000000002,30.6522015,30.869593000000002,31.0869845,31.5217675,31.739159,32.173942000000004,32.3913335,32.8261165,33.043508,33.913074,34.1304655,34.347857,34.5652485,35.0000315,35.217423000000004,35.652206,35.8695975,36.086989,37.391338,37.6087295,37.826121,38.0435125,39.3478615,39.565253,40.2174275,40.434819,41.0869935,41.266794386458336,41.304385,44.5652575,45.000040500000004,45.652215,47.391347,48.043521500000004,48.4783045,50.869611,51.5217855,51.9565685,52.608743000000004,53.2609175,53.6957005,54.347875,55.0000495,55.4348325,56.087007,58.0435305,58.15222625,58.260922,58.4783135,58.695705000000004,58.9130965,59.23918375,59.565271,59.7826625,60.217445500000004,60.434837,60.6522285,61.5217945,61.63049025,61.739186000000004,61.9565775,62.173969,62.391360500000005,62.71744775,63.043535,63.260926500000004,63.6957095,63.913101000000005,64.1304925,65.0000585,65.10875425,65.21745,65.4348415,65.652233,65.8696245,66.19571175,66.521799,66.7391905,66.84788625,66.956582,67.1739735,67.39136500000001,67.6087565,67.93484375,68.260931,68.4783225,68.58701825,68.695714,68.9131055,69.130497,69.3478885,69.67397575,70.000063,70.2174545,70.54354175,70.869629,71.08702050000001,71.9565865,72.06528225,72.173978,72.3913695,72.608761,72.8261525,73.15223975,73.47832700000001,73.6957185,74.13050150000001,74.347893,74.5652845,75.4348505,75.54354625,75.652242,75.8696335,76.087025,76.3044165,76.63050375,76.956591,77.17398250000001,77.6087655,77.826157,78.0435485,78.9131145,79.02181025,79.130506,79.3478975,79.565289,79.7826805,80.10876775,80.434855,80.6522465,80.76094225,80.869638,81.0870295,81.304421,81.5218125,81.84789975,82.173987,82.3913785,82.50007425,82.60877,82.8261615,83.043553,83.26094450000001,83.58703175000001,83.91311900000001,84.1305105,84.45659775,84.782685,85.0000765,86.30442550000001,86.7392085,87.391383,89.130515,89.7826895,90.2174725,92.608779,93.2609535,93.6957365,94.347911,95.0000855,95.43486850000001,96.08704300000001,96.7392175,97.1740005,97.826175,99.78269850000001]
var lanes = [0,1,0,2,2,3,2,0,0,1,0,2,2,3,2,0,0,1,0,2,2,3,2,0,0,1,0,2,2,3,2,0,1,0,3,2,3,2,0,0,1,0,3,2,3,2,3,2,1,3,3,1,2,1,3,2,0,1,1,0,2,3,0,1,0,3,2,3,2,0,0,1,0,3,2,3,0,3,0,2,3,1,0,3,0,1,0,2,0,3,0,3,1,0,1,0,3,0,1,0,3,0,3,2,3,0,0,1,0,3,0,2,3,1,0,3,0,1,0,2,0,3,0,3,1,0,1,0,3,0,1,0,3,0,3,2,3,0,1,2,3,1,0,2,2,0,2,2,3,2,2,0,0,0,3,2,3,2,1,2,3,3,0,1,0,0,3,2,3,2,1,2,3,3,0,2,1,1,3,2,3,2,1,2,1,1,2,3,0,2,1,0,1,1,3,2,1,3,0,2,3,2,3,1,0,0,3,2,3,2,1,2,3,3,0,1,0,0,3,2,3,2,1,2,3,3,0,2,1,1,3,2,3,2,1,2,1,1,2,3,0,2,1,0,1,1,3,2,1,3,0,2,3,2,3,1,0,1,3,2,3,1,0,2,2,0,2,2,3,2,2,0]
var currentNote = 0
var instance
var lane

# Called when the node enters the scene tree for the first time.
func _ready():
	randomize()
	$Conductor.play_with_beat_offset(4)

# Called every frame. 'delta' is the elapsed time since the previous frame.
func _process(_delta):
	_spawn_notes()
	
func _on_Note_Pressed(notePressed):
	pass

func _on_Conductor_beat(_beatPosition):
	pass

func _on_Conductor_bar(_barPosition):
	pass
	
func _spawn_notes():
	if currentNote < (notes.size() - 1):
		if $Conductor.songPosition >= notes[currentNote]:
			instance = note.instantiate()
			instance.initialize(lanes[currentNote], bpm, currentNote)
			currentNote += 1
			add_child(instance)
			instance.connect("destroyed", _on_note_destroy)
		
func _on_note_destroy(index, hit):
	var adjustedSongPosition = $Conductor.songPosition - (secsPerBeat * 3)
	# print("Index: ", index)
	# print("Hit: ", hit)
	# print("Note: ", notes[index])
	# print("Song Position: ", adjustedSongPosition)
	var offset = (notes[index] * -1) + adjustedSongPosition
	print("Offset: ", offset)
	$AudioStreamPlayer.play()
	if hit:
		$AudioStreamPlayer.play()
		if offset < perfectTimingWindow && offset > (perfectTimingWindow * -1):
			print("Perfect")
		elif offset < goodTimingWindow && offset > (goodTimingWindow * -1):
			print("Good")
		elif offset >= goodTimingWindow:
			print("Late")
		elif offset <= (goodTimingWindow * -1):
			print("Early")
	else:
		print("Miss")
